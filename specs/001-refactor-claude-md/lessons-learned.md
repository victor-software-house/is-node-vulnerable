# Lessons Learned: CLAUDE.md Refactoring

**Feature**: 001-refactor-claude-md
**Date**: 2026-01-15

## Critical Security Violation Detected During Implementation

### Issue

During implementation of User Story 1 (Task T011), Configuration Repositories section was nearly added to README.md, which would have violated the global security directive:

> NEVER mention Claude, Claude Code, Anthropic, or ANY AI tools in:
> - Git commit messages
> - Committed files (code, documentation, comments, etc.)
> - Files that will be pushed to remote repositories

**Violation**: README.md is a tracked file in the main repository. Mentioning `.claude/`, `.specify/`, or any AI assistant configuration would breach NDA/security requirements.

### Root Cause

1. **Planning Phase Oversight**: Tasks.md (generated by `/speckit.tasks`) included T011 which explicitly requested adding Configuration Repositories to README.md
2. **Specification Ambiguity**: The data-model.md and plan.md didn't include validation gates for AI tool mentions in tracked files
3. **Missing Validation**: No automated check exists to prevent AI tool mentions in tracked files before commit

### Resolution

1. [DONE] Removed Configuration Repositories section from README.md immediately
2. [DONE] Marked T011 as "SKIP - SECURITY VIOLATION" in tasks.md with clear reasoning
3. [DONE] Documented this lesson learned for future reference

### Prevention Strategies

#### 1. Constitution Principle: AI Tool Mention Prevention

**Proposed New Principle**:

```markdown
## Principle VII: AI Tool Mention Prevention (Security/NDA)

**Rule**: NEVER mention AI assistants, configuration directories, or AI-related tools in tracked files.

**Prohibited Mentions in Tracked Files**:
- Claude, Claude Code, Anthropic
- .claude/, .specify/, or any hidden AI config directories
- "AI assistant", "AI-specific", "memory file", "context loading"
- Links to AI configuration repositories
- Any reference to AI automation or AI-driven workflows

**Allowed Mentions**:
- ONLY in files excluded via .git/info/exclude (.claude/CLAUDE.md, .specify/*)
- ONLY when user EXPLICITLY requests AI tool mentions

**Enforcement**:
- Pre-commit hook to scan staged files for prohibited terms
- Planning phase validation: Review all tasks for tracked file modifications
- Implementation gate: Before committing, verify no AI tool mentions

**Penalty for Violation**: Immediate rollback and security review
```

#### 2. Pre-Commit Hook Implementation

Create `.claude/hooks/pre-commit-ai-mention-check.sh`:

```bash
#!/bin/bash
# Pre-commit hook: Check for AI tool mentions in tracked files

PROHIBITED_TERMS=(
  "Claude Code"
  "\.claude/"
  "\.specify/"
  "Anthropic"
  "AI assistant"
  "memory file"
  "claude-config"
  "specify-config"
)

# Get staged files (excluding .claude/ and .specify/ directories)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -v "^\.claude/" | grep -v "^\.specify/")

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

VIOLATIONS_FOUND=0

for FILE in $STAGED_FILES; do
  for TERM in "${PROHIBITED_TERMS[@]}"; do
    if git diff --cached "$FILE" | grep -i "$TERM" > /dev/null 2>&1; then
      echo "SECURITY VIOLATION: Found '$TERM' in tracked file: $FILE"
      VIOLATIONS_FOUND=1
    fi
  done
done

if [ $VIOLATIONS_FOUND -eq 1 ]; then
  echo ""
  echo "COMMIT BLOCKED: AI tool mentions detected in tracked files"
  echo "Remove all mentions of Claude, .claude/, .specify/, or AI tools from tracked files"
  echo "These mentions are only allowed in .claude/CLAUDE.md (excluded from repo)"
  exit 1
fi

exit 0
```

#### 3. Planning Phase Validation Gate

Add validation step to `/speckit.tasks` command:

**Before generating tasks.md**, validate that:
1. No task modifies tracked files to add AI tool mentions
2. Configuration Repositories sections stay in CLAUDE.md only
3. README.md enhancements exclude AI-specific content

#### 4. Updated Task Template

When generating tasks for README.md enhancements, use this template:

```markdown
### README.md Enhancement Tasks

**CRITICAL VALIDATION**: README.md is a TRACKED file. Verify subsections do NOT include:
- [ ] AI tool mentions (Claude, Claude Code, Anthropic)
- [ ] Configuration directories (.claude/, .specify/)
- [ ] Links to AI configuration repositories
- [ ] AI-specific workflows or automation

**Approved Subsections for README.md**:
- [ ] Commands (development, build, test, lint)
- [ ] Architecture (module structure, build system, data flow)
- [ ] Testing (framework, patterns, coverage)
- [ ] GitHub Actions (automation workflows - no AI mentions)
- [ ] ~~Configuration Repositories~~ **FORBIDDEN - AI tool mention**
```

### Validation Checklist for Future Features

Before committing any documentation changes:

- [ ] Is the file tracked in git? (Check with `git ls-files <file>`)
- [ ] Does it mention Claude, Claude Code, or Anthropic?
- [ ] Does it reference .claude/ or .specify/ directories?
- [ ] Does it link to AI configuration repositories?
- [ ] Does it describe AI-specific workflows?

If YES to any question: **REMOVE the mention or move content to .claude/CLAUDE.md**

### Long-Term Solution

**Recommendation**: Implement pre-commit hook as mandatory project setup step in:
- Project initialization scripts
- `.claude/PROJECT-SETUP-GUIDE.md`
- First-time developer onboarding checklist

---

**Status**: Violation prevented before commit. README.md corrected. Tasks.md updated. Prevention strategies documented.

**Next Steps**:
1. Add Principle VII to global constitution (when constitution file is created)
2. Implement pre-commit hook for AI mention detection
3. Update `/speckit.tasks` command to include validation gate
4. Add to PROJECT-SETUP-GUIDE.md as mandatory setup step
