/**
 * Vulnerability checking logic
 */

import { satisfies, valid } from 'semver';
import * as z from 'zod';

import type { Platform, VulnerabilityEntry } from '@/types';

import securityData from '@/data/security.json' with { type: 'json' };
import { isNodeEOL } from '@/schedule';
import { securityDatabaseSchema } from '@/schemas';
import { PLATFORMS } from '@/types';

type SecurityDatabase = z.output<typeof securityDatabaseSchema>;

/**
 * Validate that a platform string is a valid Platform type
 *
 * @param platform - Platform string to validate
 * @throws Error if platform is not valid
 */
export function checkPlatform(
	platform?: string,
): asserts platform is Platform | undefined {
	if (platform !== undefined && !PLATFORMS.includes(platform as Platform)) {
		throw new Error(
			`Platform '${platform}' is not valid. Use: ${PLATFORMS.join(', ')}`,
		);
	}
}

export function getVulnerabilityList(
	currentVersion: string,
	platform?: Platform,
	securityDb?: SecurityDatabase,
): VulnerabilityEntry[] {
	const vulnerabilities: VulnerabilityEntry[] = [];

	for (const vuln of Object.values(securityDb ?? {})) {
		const isVulnerable =
			satisfies(currentVersion, vuln.vulnerable) &&
			!satisfies(currentVersion, vuln.patched);

		const isPlatformAffected = isSystemAffected(
			vuln.affectedEnvironments,
			platform,
		);

		if (isVulnerable && isPlatformAffected) {
			vulnerabilities.push(vuln);
		}
	}

	return vulnerabilities;
}

/**
 * Check if a Node.js version is vulnerable to known CVEs
 *
 * @param version - Node.js version (e.g., "v20.10.0", "18.0.0")
 * @param platform - Optional platform (darwin, linux, win32, etc.)
 * @returns True if vulnerable or end-of-life, false otherwise
 * @throws Error if version or platform is invalid
 *
 * @example
 * ```typescript
 * const vulnerable = isNodeVulnerable('v20.10.0', 'darwin');
 * console.log(vulnerable); // false
 * ```
 */
export function isNodeVulnerable(
	platform?: Platform,
	version?: string,
): boolean {
	validateVersion(version ?? '');
	checkPlatform(platform);

	const isEOL = isNodeEOL(version ?? '');
	if (isEOL) {
		return true;
	}

	const securityDb = z.parse(securityDatabaseSchema, securityData);

	const vulnerabilities = getVulnerabilityList(
		version ?? '',
		platform,
		securityDb,
	);

	return vulnerabilities.length > 0;
}

function isSystemAffected(
	affectedEnvironments?: string[],
	platform?: Platform,
): boolean {
	if (platform === undefined || !Array.isArray(affectedEnvironments)) {
		return true;
	}

	return (
		affectedEnvironments.includes(platform) ||
		affectedEnvironments.includes('all')
	);
}

/**
 * Validate a semver version string
 *
 * @param version - Version string to validate
 * @throws Error if version is invalid
 */
function validateVersion(version: string): void {
	if (valid(version) === null) {
		throw new Error(`Invalid semver version: ${version}`);
	}
}
