/**
 * Vulnerability checking logic
 */

import { satisfies } from 'semver';

import { CACHE_STORE, fetchWithCache } from './cache.js';
import { isNodeEOL } from './schedule.js';
import { securityDatabaseSchema } from './schemas.js';
import type {
   Platform,
   PLATFORMS,
   SecurityDatabase,
   VulnerabilityEntry,
} from './types.js';

export function checkPlatform(platform?: string): asserts platform is Platform {
   if (platform && !PLATFORMS.includes(platform as Platform)) {
      throw new Error(
         `Platform '${platform}' is not valid. Use: ${PLATFORMS.join(', ')}`,
      );
   }
}

function isSystemAffected(
   platform: Platform | undefined,
   affectedEnvironments?: string[],
): boolean {
   if (!platform || !Array.isArray(affectedEnvironments)) {
      return true;
   }

   return (
      affectedEnvironments.includes(platform) ||
      affectedEnvironments.includes('all')
   );
}

export function getVulnerabilityList(
   currentVersion: string,
   securityDb: SecurityDatabase,
   platform?: Platform,
): VulnerabilityEntry[] {
   const vulnerabilities: VulnerabilityEntry[] = [];

   /* eslint-disable @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-call -- Type-safe: securityDb validated by Zod */
   for (const vuln of Object.values(securityDb)) {
      const isVulnerable =
         satisfies(currentVersion, vuln.vulnerable) &&
         !satisfies(currentVersion, vuln.patched);
      /* eslint-enable @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-call */

      const isPlatformAffected = isSystemAffected(
         platform,
         vuln.affectedEnvironments,
      );

      if (isVulnerable && isPlatformAffected) {
         vulnerabilities.push(vuln);
      }
   }

   return vulnerabilities;
}

export async function isNodeVulnerable(
   version: string,
   platform?: Platform,
): Promise<boolean> {
   checkPlatform(platform);

   const isEOL = await isNodeEOL(version);
   if (isEOL) {
      return true;
   }

   const securityDb = await fetchWithCache<SecurityDatabase>(
      CACHE_STORE.security,
      securityDatabaseSchema,
   );

   const vulnerabilities = getVulnerabilityList(version, securityDb, platform);

   return vulnerabilities.length > 0;
}
